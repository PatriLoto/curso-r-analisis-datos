
---
output:
  xaringan::moon_reader:
    lib_dir: libs
    css:  ["default", "default-fonts", "animate.css",  "hygge"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: true
---
class: inverse, center
```{r , message=FALSE, warning=FALSE, include=FALSE} 
library(fontawesome)
library(emo)
```

# `r fa("r-project", fill = 'steelblue')`  para análisis de datos `r emo::ji("rocket")`<br> <br> 

## `r emo::ji("tada")`Modelización con tidymodels `r emo::ji("computer")`
### Titanic 

<br> <br> <br> 

.large[Roxana N. Villafañe | LEMyP | <a href='http://twitter.com/data_datum'>`r fa("twitter", fill = 'steelblue')` @data_datum</a>] <br> 
.large[Florencia D'Andrea | INTA-CONICET | <a href="http://twitter.com/cantoflor_87"> `r fa("twitter", fill = 'steelblue')` @cantoflor_87</a><br>] 


<br><br><br><br><br> Slides disponibles en <https://bit.ly/curso-r-fca> `r emo::ji("sparkles")`
<br> Página web del curso en <https://curso-r-fca.netlify.com> `r emo::ji("star2")`

---

background-image: url(C:/Users/Roxana/curso-r-analisis-datos/img/text-msg.png)
background-size: cover
class: center, middle

# `r emo::ji("sparkles")` Data Desbalanceada

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Dataset: Titanic

Link: https://www.kaggle.com/c/titanic/data




---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Ingreso de los datos
```{r warning=FALSE, message=FALSE} 
library(readr)
train_titanic<-read.csv("C://Users/Roxana/curso-r-analisis-datos/data/train_titanic.csv")
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

```{r warning=FALSE, message=FALSE} 
head(train_titanic)
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

### Tenemos en total 891 casos y 12 variables
```{r warning=FALSE, message=FALSE} 
str(train_titanic)
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Vamos a eliminar los datos que no son importantes para la predicción

```{r warning=FALSE, message=FALSE} 
library(dplyr)
cols<-c("Name", "Ticket", "Sex", "Cabin", "Embarked")
train_titanic <- train_titanic %>%
  select(-cols)%>%
  select_all(tolower)
train_titanic
```



---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Valores perdidos con `is.na()`

```{r warning=FALSE, message=FALSE} 
any(is.na(train_titanic))
```

* Borramos los datos perdidos con `na.omit()`

```{r warning=FALSE, message=FALSE} 
train_titanic_clean <-na.omit(train_titanic)
str(train_titanic_clean)
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

## Verificamos que no estén los valores perdidos

```{r warning=FALSE, message=FALSE} 
any(is.na(train_titanic_clean))
```
### Pasamos a tener 714 casos y 7 variables


```{r warning=FALSE, message=FALSE, echo=FALSE} 
str(train_titanic_clean)
```
---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Vamos a ver cuántos casos hay por grupos: `Survived`

```{r warning=FALSE, message=FALSE} 
train_titanic_clean %>%
  group_by(survived) %>%
  count()
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/rsample.png" width="10%" align="right" />

# Balancear el dataset 

### Como el dataset está desbalanceado, vamos a balancearlos de la siguiente forma

```{r message=FALSE, warning=FALSE, eval=FALSE} 
library(recipes)
titanic_balanceado<- 
  recipe(survived ~ ., data = train_titanic_clean) %>%
  step_downsample(survived) %>%
titanic_balanceado
```


---
# Vamos a convertir en factor la variable respuesta

```{r warning=FALSE, message=FALSE} 
library(dplyr)
train_titanic_clean2<-train_titanic_clean %>%
  mutate(surv = case_when(
    survived=="0" ~ "died",
    survived=="1" ~ "lived"
  )) 
train_titanic_clean2
```

---
```{r warning=FALSE, message=FALSE} 
train_titanic_clean2 <-train_titanic_clean2 %>%
  select(-survived) %>%
  rename(survived = surv)
train_titanic_clean2
```

---

```{r warning=FALSE, message=FALSE} 
train_titanic_clean2 %>%
  group_by(survived) %>%
  count()
```
---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />


```{r warning=FALSE, message=FALSE} 
library(rsample)
titanic_split <- rsample::initial_split(train_titanic_clean2, prop = 0.9)
titanic_split
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Creamos la receta

```{r warning=FALSE, message=FALSE} 
library(recipes)
titanic_recipe <- training(titanic_split) %>%
  recipe(survived~., data=titanic_split) %>%
  step_downsample(survived) %>%
  step_corr(all_predictors()) %>%
  step_center(all_predictors(), -all_outcomes()) %>%
  step_scale(all_predictors(), -all_outcomes()) %>%
  prep()
```


---

```{r warning=FALSE, message=FALSE} 
library(recipes)
titanic_recipe <- training(titanic_split) %>%
  recipe(survived~., data=titanic_split) %>%
  step_downsample(survived) %>%
  step_corr(all_predictors()) %>%
  step_center(all_predictors(), -all_outcomes()) %>%
  step_scale(all_predictors(), -all_outcomes()) %>%
  prep()
titanic_recipe
```

---
```{r } 
titanic_training <- juice(titanic_recipe)
head(titanic_training)
```

---

```{r } 
titanic_testing <- titanic_recipe %>%
  bake(testing(titanic_split)) 

titanic_testing
```


---

```{r } 
library(parsnip)
titanic_ranger <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("ranger") %>%
  fit(survived~., data = titanic_training)

titanic_ranger
```

---

{randomForest}
```{r } 
titanic_rf <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("randomForest") %>%
  fit(survived~., data = titanic_training)

titanic_rf
```

---

## 4° Validación
{ranger}
```{r message=FALSE, warning=FALSE} 
library(yardstick)
titanic_ranger %>%
  predict(titanic_testing) %>%
  bind_cols(titanic_testing) %>%
  metrics(truth=survived, estimate=.pred_class)
```

---

{randomForest}
```{r } 
titanic_rf %>%
  predict(titanic_testing) %>%
  bind_cols(titanic_testing) %>%
  metrics(truth=survived, estimate=.pred_class)
```
---
{ranger}
```{r } 
titanic_ranger %>%
  predict(titanic_testing, type="prob")
```

---
{ranger}
```{r } 
titanic_probs <- titanic_ranger %>%
  predict(titanic_testing, type = "prob") %>%
  bind_cols(titanic_testing) %>%
  select(.pred_died, .pred_lived, survived, everything())
titanic_probs
```

---

```{r } 
titanic_probs %>%
  gain_curve(.pred_lived, truth=survived) %>%
  glimpse()
```

---

```{r } 
titanic_ranger %>%
  predict(titanic_testing) %>%
  bind_cols(titanic_testing) %>%
  select(.pred_class, survived, everything())
```

---


```{r } 
library(ggplot2)
titanic_probs%>%
  gain_curve(.pred_lived, truth=survived) %>%
  autoplot()
```

---

```{r } 
predict(titanic_ranger, titanic_testing, type = "prob") %>%
  bind_cols(predict(titanic_ranger, titanic_testing)) %>%
  bind_cols(select(titanic_testing, survived)) %>%
  metrics(survived, estimate = .pred_class)

```

