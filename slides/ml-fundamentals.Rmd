---
output:
  xaringan::moon_reader:
    lib_dir: libs
    css:  ["default", "default-fonts", "animate.css",  "hygge"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: true
---
class: inverse, center
```{r , message=FALSE, warning=FALSE, include=FALSE} 
library(fontawesome)
library(emo)
```

# `r fa("r-project", fill = 'steelblue')`  para análisis de datos `r emo::ji("rocket")`<br> <br> 

## `r emo::ji("tada")`Modelización con tidymodels `r emo::ji("computer")`<br> <br> <br> 

.large[Roxana N. Villafañe | LEMyP | <a href='http://twitter.com/data_datum'>`r fa("twitter", fill = 'steelblue')` @data_datum</a>] <br> 
.large[Florencia D'Andrea | INTA-CONICET | <a href="http://twitter.com/cantoflor_87"> `r fa("twitter", fill = 'steelblue')` @cantoflor_87</a><br>] 


<br><br><br><br><br> Slides disponibles en <https://bit.ly/curso-r-fca> `r emo::ji("sparkles")`
<br> Página web del curso en <https://curso-r-fca.netlify.com> `r emo::ji("star2")`

---
class:center, inverse

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="50%" align="middle" />

---


<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

<br><br>
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidym1.png" width="100%" align="center" />


---

background-image: url(C:/Users/Roxana/curso-r-analisis-datos/img/fondo-madera.png)
background-size: cover
class: center, middle

# Tidymodels es un grupo de paquetes centrado en las tareas de modelización de datos. 
# La modelización consta de varios pasos, la idea es que cada paso lo realice una librería diferente. 


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

<br><br>
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidym2.png" width="100%" align="center" />

--

### Documentación
- Tidymodels https://github.com/tidymodels/tidymodels
- Rsample https://tidymodels.github.io/rsample/
- Recipes https://tidymodels.github.io/recipes/reference/index.html
- Parsnip https://tidymodels.github.io/parsnip/
- Yardstick https://tidymodels.github.io/yardstick/ 

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />


# En primer lugar instalamos tidymodels
```{r eval=FALSE} 
install.packages(tidymodels)
```


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />


# Librerías de Tidymodels
```{r } 
library(tidymodels)
```

---
background-image: url(C:/Users/Roxana/curso-r-analisis-datos/img/text-msg.png)
background-size: cover
class: center, middle

# `r emo::ji("sparkles")` 


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Dataset: Sonar
Como podemos ver las clases están prácticamente balanceadas

```{r warning=FALSE, message=FALSE} 
library(mlbench)
data(Sonar)
```


```{r } 
summary(Sonar)
```

---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/rsample.png" width="50%" align="center" />

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/rsample.png" width="10%" align="right" />

# 1° Paso: Dividir los datos

### Crear un set de datos training / testing con la librería *rsamples*


```{r } 
sonar_split <- rsample::initial_split(Sonar, prop = 0.6)
sonar_split
```


Estos son los datos de training/testing/total 

---
background-image: url(C:/Users/Roxana/curso-r-analisis-datos/img/text2.png)
background-size: cover
class: center, middle, inverse

 

# `r emo::ji("computer")` DEMO `r emo::ji("computer")`



---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.jpg" width="60%" align="center" />

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes_allison.png" width="100%" align="center" />


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.jpg" width="10%" align="right" />

# 2° Paso: Preprocesamiento

- **recipe()**: empieza una lista de transformaciones a ser aplicadas
- **prep()**: Indica que hay que ejecutar todos los pasos anteriores. 
<br>
- **step_corr()**: remueve todas las variables con alta correlación
- **step_center()**: centrar los datos con media igual a 0. 
- **step_scale()**: Normaliza con desvío estándar igual a 1. 
<br>
- **all_predictors()** y **all_outcomes()** son todas las variables predictivas y predictoras


```{r eval=FALSE} 
sonar_recipe <- training(sonar_split) %>%
  recipe(Class~.) %>%
  step_corr(all_predictors()) %>%
  step_center(all_predictors(), -all_outcomes()) %>%
  step_scale(all_predictors(), -all_outcomes()) %>%
  prep()

```


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.jpg" width="10%" align="right" />

```{r } 
sonar_recipe <- training(sonar_split) %>%
  recipe(Class~.) %>%
  step_corr(all_predictors()) %>%
  step_center(all_predictors(), -all_outcomes()) %>%
  step_scale(all_predictors(), -all_outcomes()) %>%
  prep()

```

```{r } 
sonar_recipe
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.jpg" width="10%" align="right" />

- **juice()** se utiliza para darle formato final al dataset antes del procesamiento de los datos

```{r } 
sonar_training <- juice(sonar_recipe)

head(sonar_training)
```


.footnote[https://tidymodels.github.io/recipes/reference/juice.html
]

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.jpg" width="10%" align="right" />

```{r } 
sonar_testing <- sonar_recipe %>%
  bake(testing(sonar_split)) 

sonar_testing
```


.footnote[https://tidymodels.github.io/recipes/reference/bake.html
]
---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip_h.png" width="70%" align="center" />

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip_allison.png" width="100%" align="center" />

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

## 3° Entrenamiento

- Para a entrenar un modelo de random forest con librería {ranger} y {randomForest} en el set de entrenamiento. 
- Se puede entrenar cualquier modelo de clasificación
```{r eval=FALSE} 
sonar_ranger <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("ranger") %>%
  fit(Class~., data = sonar_training)

sonar_ranger
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />
{ranger}
```{r } 
sonar_ranger <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("ranger") %>%
  fit(Class~., data = sonar_training)

sonar_ranger
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

{randomForest}
```{r } 
sonar_rf <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("randomForest") %>%
  fit(Class~., data = sonar_training)

sonar_rf
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

```{r } 
predict(sonar_ranger, sonar_testing)

```



---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

```{r } 
sonar_ranger %>%
  predict(sonar_testing) %>%
  bind_cols(sonar_testing) 

```

---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.png" width="60%" align="center" />



---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

### 4° Validación

```{r } 
sonar_ranger %>%
  predict(sonar_testing) %>%
  bind_cols(sonar_testing) %>%
  metrics(truth=Class, estimate=.pred_class)
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
sonar_rf %>%
  predict(sonar_testing) %>%
  bind_cols(sonar_testing) %>%
  metrics(truth=Class, estimate=.pred_class)
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

```{r } 
sonar_ranger %>%
  predict(sonar_testing, type="prob")
```
---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
sonar_probs <- sonar_ranger %>%
  predict(sonar_testing, type = "prob") %>%
  bind_cols(sonar_testing)
sonar_probs
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
sonar_probs %>%
  gain_curve(.pred_M, truth=Class) %>%
  glimpse()
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

```{r } 
sonar_probs%>%
  gain_curve(.pred_M, truth=Class) %>%
  autoplot()
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

```{r } 
sonar_probs%>%
  roc_curve(.pred_M, truth=Class) %>%
  autoplot()
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
predict(sonar_ranger, sonar_testing, type = "prob") %>%
  bind_cols(predict(sonar_ranger, sonar_testing)) %>%
  bind_cols(select(sonar_testing, Class)) %>%
  metrics(Class, .pred_M, estimate = .pred_class)

```


---
# Bibliografía

- Tutorial de Tidymodels
https://rviews.rstudio.com/2019/06/19/a-gentle-intro-to-tidymodels/
- Tutorial de Tidymodels (español)
https://diegokoz.github.io/EEA2019/clase%208/tidymodels.nb.html
- parsnip: A tidy model interface - Max Kuhn (video)
bit.ly/parsnip-rstudioconf2019 
- Recipes for data Preprocessing - Max Kuhn (video)
bit.ly/recipes-useR2018






---

```{r } 
sessionInfo() 
```
