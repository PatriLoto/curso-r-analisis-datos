---
output:
  xaringan::moon_reader:
    lib_dir: libs
    css:  ["default", "default-fonts", "animate.css",  "hygge"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: true
---
class: inverse, center
```{r , message=FALSE, warning=FALSE, include=FALSE} 
library(fontawesome)
library(emo)
```

# `r fa("r-project", fill = 'steelblue')`  para análisis de datos `r emo::ji("rocket")`<br> <br> 

## `r emo::ji("tada")`Modelización con tidymodels `r emo::ji("computer")`<br> <br> <br> 

.large[Roxana N. Villafañe | LEMyP | <a href='http://twitter.com/data_datum'>`r fa("twitter", fill = 'steelblue')` @data_datum</a>] <br> 
.large[Florencia D'Andrea | INTA-CONICET | <a href="http://twitter.com/cantoflor_87"> `r fa("twitter", fill = 'steelblue')` @cantoflor_87</a><br>] 


<br><br><br><br><br> Slides disponibles en <https://bit.ly/curso-r-fca> `r emo::ji("sparkles")`
<br> Página web del curso en <https://curso-r-fca.netlify.com> `r emo::ji("star2")`

---
class:center, inverse

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="50%" align="middle" />

---


<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Flujo de Ciencia de Datos `r emo::ji("pushpin")`

<img src="C://Users/Roxana/curso-r-analisis-datos/img/flujo-ciencia-datos.png" width="100%" align="center" />


---

background-image: url(C:/Users/Roxana/curso-r-analisis-datos/img/fondo-madera.png)
background-size: cover
class: center, middle

# Tidymodels es un grupo de paquetes centrado en las tareas de modelización de datos. 
# La modelización consta de varios pasos, la idea es que cada paso lo realice una librería diferente. 


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

<br><br>
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidym2.png" width="100%" align="center" />

--

### Documentación
- Tidymodels https://github.com/tidymodels/tidymodels
- Rsample https://tidymodels.github.io/rsample/
- Recipes https://tidymodels.github.io/recipes/reference/index.html
- Parsnip https://tidymodels.github.io/parsnip/
- Yardstick https://tidymodels.github.io/yardstick/ 

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />


# En primer lugar instalamos tidymodels
```{r eval=FALSE} 
install.packages(tidymodels)
```


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />


# Librerías de Tidymodels
```{r } 
library(tidymodels)
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Modelización supervisada

### Clasificación: la variable respuesta es una clase, es decir, una variable cualitativa 
En el dataset iris, el tipo de flor, iris setosa, versicolor, virginica.
### Regresión: la variable respuesta es un valor cuantitativo (un valor numérico a predecir). 
Predicción de precios de casas, según variables como el barrio en el que pertenecen, número de cuartos, si es de más de un piso, etc. 



---
background-image: url(C:/Users/Roxana/curso-r-analisis-datos/img/text-msg.png)
background-size: cover
class: center, middle

# `r emo::ji("sparkles")` Data Balanceada


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Dataset: Iris

* Conjunto de datos muy popular en análisis multivariado

<img src="C://Users/Roxana/curso-r-analisis-datos/img/iris-species.png" width="100%" align="center" />


.footnote[[*]
Mas información en https://es.wikipedia.org/wiki/Conjunto_de_datos_flor_iris 
https://archive.ics.uci.edu/ml/datasets/Iris]

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Vemos los primeros 5 casos del set de datos 
```{r warning=FALSE, message=FALSE} 
head(iris)
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

# Estadística descriptiva del set de datos
```{r warning=FALSE, message=FALSE} 
summary(iris)
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/tidymodels.png" width="10%" align="right" />

## Tenemos 150 casos o individuos (filas), 4 columnas o características (features) y 1 variable predictora (species)
```{r warning=FALSE, message=FALSE} 
str(iris)
```

---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/rsample.png" width="50%" align="center" />


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/rsample.png" width="10%" align="right" />

# 1° Paso: Dividir los datos

### Crear un set de datos training / testing con la librería *rsamples*


```{r } 
iris_split <- rsample::initial_split(iris, prop = 0.6)
iris_split
```


Estos son los datos de training/testing/total 


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/rsample.png" width="10%" align="right" />

# Training / testing


<img src="C://Users/Roxana/curso-r-analisis-datos/img/training-testing.png" width="75%" align="center" />



---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="60%" align="center" />

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes_allison.png" width="100%" align="center" />


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

# Preprocesamiento

Dentro de esta etapa se incluyen tareas como:
### Centrado
### Escalado
### Remover variables que presenten alta correlación

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

# Centrado y Escalado

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

# Remover variables que presenten alta correlación




---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

# 2° Paso: Preprocesamiento

- **recipe()**: empieza una lista de transformaciones a ser aplicadas
<br>
- **step_corr()**: remueve todas las variables con alta correlación
- **step_center()**: centrar los datos con media igual a 0. 
- **step_scale()**: Normaliza con desvío estándar igual a 1. 
<br>
- **all_predictors()** y **all_outcomes()** son todas las variables predictivas y predictoras
- **prep()**: Indica que hay que ejecutar todos los pasos anteriores. 

```{r } 
iris_recipe <- training(iris_split) %>%
  recipe(Species~.) %>%
  step_corr(all_predictors()) %>%
  step_center(all_predictors(), -all_outcomes()) %>%
  step_scale(all_predictors(), -all_outcomes()) %>%
  prep()

```


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

```{r } 
iris_recipe <- training(iris_split) %>%
  recipe(Species~.) %>%
  step_corr(all_predictors()) %>%
  step_center(all_predictors(), -all_outcomes()) %>%
  step_scale(all_predictors(), -all_outcomes()) %>%
  prep()

```

```{r } 
iris_recipe
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

## juice()
- **juice()** se utiliza para darle formato final al dataset antes del procesamiento de los datos
#### juice() aplicamos a los datos de entrenamiento
```{r } 
iris_training <- juice(iris_recipe)
```

```{r } 
head(iris_training)
```

.footnote[https://tidymodels.github.io/recipes/reference/juice.html
]

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" />

## bake()
- **bake()** toma un recipiente entreanado y aplica las operaciones a un set de datos para crear la matriz de diseño. 

### Matriz de diseño (Design Matrix)

En estadística, una matriz de diseño (también conocida como matriz regresora, o matriz de modelo) es una matriz de valores de variables explicativas de un set de objetos, generalmente denotada por X. Cada fila representa un objeto individual, con las columnas representando a las variables y sus valores específicos para cada objeto. 

.footnote[https://tidymodels.github.io/recipes/reference/bake.html y https://tidymodels.github.io/recipes/
]

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/recipes.png" width="10%" align="right" /> 

### bake() aplicamos a los datos de prueba
```{r } 
iris_testing <- iris_recipe %>%
  bake(testing(iris_split)) 
```

```{r } 
iris_testing
```


---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip_h.png" width="70%" align="center" />

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip_allison.png" width="100%" align="center" />

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

# Árboles de decisión (Decision Trees)



---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

# Bosques aleatorios (Random Forest)

* Random Forest usa como algoritmo base los árboles de decisión

<img src="C://Users/Roxana/curso-r-analisis-datos/img/random-forest.png" width="65%" align="center" />

.footnote[[*]
Imagen tomada de _Python Machine Learning_ (2015) Sebastian Raschka ]

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

## 3° Paso: Entrenamiento del modelo

- Para a entrenar un modelo de random forest con librería {ranger} y {randomForest} en el set de entrenamiento. 
- Se puede entrenar cualquier modelo de clasificación

```{r eval=FALSE} 
iris_ranger <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("ranger") %>%
  fit(Species~., data = iris_training)

iris_ranger
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />
{ranger}
```{r echo=FALSE} 
iris_ranger <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("ranger") %>%
  fit(Species~., data = iris_training)

iris_ranger
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

{randomForest}
```{r } 
iris_rf <- rand_forest(trees = 100, mode = "classification") %>%
  set_engine("randomForest") %>%
  fit(Species~., data = iris_training)

iris_rf
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

# Evaluación de un clasificador 

<img src="C://Users/Roxana/curso-r-analisis-datos/img/eval-clasificador.png" width="100%" align="right" />



---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

# Matriz de Confusión

<img src="C://Users/Roxana/curso-r-analisis-datos/img/matriz-confusion.png" width="100%" align="right" />


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

```{r } 
predict(iris_ranger, iris_testing)

```



---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/parsnip.png" width="15%" align="right" />

```{r } 
iris_ranger %>%
  predict(iris_testing) %>%
  bind_cols(iris_testing) 

```

---
class: inverse, center

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.png" width="60%" align="center" />



---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

## 4° Paso: Validación del modelo

### Random Forest con librería `ranger`
```{r } 
iris_ranger %>%
  predict(iris_testing) %>%
  bind_cols(iris_testing) %>%
  metrics(truth=Species, estimate=.pred_class)
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

### Random Forest con librería `random forest`
```{r } 
iris_rf %>%
  predict(iris_testing) %>%
  bind_cols(iris_testing) %>%
  metrics(truth=Species, estimate=.pred_class)
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

```{r } 
iris_ranger %>%
  predict(iris_testing, type="prob")
```
---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
iris_probs <- iris_ranger %>%
  predict(iris_testing, type = "prob") %>%
  bind_cols(iris_testing)
iris_probs
```

---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
iris_probs %>%
  gain_curve(.pred_setosa:.pred_virginica, truth=Species) %>%
  glimpse()
```


---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

```{r } 
library(yardstick)
iris_probs%>%
  gain_curve(.pred_setosa:.pred_virginica, truth=Species) %>%
  autoplot()
```

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

# Curvas ROC

* Las curvas ROC son una poderosa herramienta gráfica para visualizar el desempeño de un algoritmo de aprendizaje a través de una variación en el criterio de decisión. 
<br><br>
* Las curvas ROC se han utilizado no sólo para __estudiar el comportamiento de un algoritmo__ sino también __identificar regiones óptimas de desempeño__, __realizar la selección de modelos__, y lo más importante para __comparar y evaluar algoritmos de aprendizaje automático__. 
<br><br>
* En el _eje X_ de una curva ROC tenemos el eje horizontal, que muestra la _tasa de falsos positivos (TFP)_ y el eje vertical (_eje y_) muestra la _tasa de verdaderos positivos_ de un clasificador. 

---
<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />

```{r } 
iris_probs%>%
  roc_curve(.pred_setosa:.pred_virginica, truth=Species) %>%
  autoplot()
```


---

<img src="C://Users/Roxana/curso-r-analisis-datos/img/yardstick.jpg" width="10%" align="right" />


```{r } 
predict(iris_ranger, iris_testing, type = "prob") %>%
  bind_cols(predict(iris_ranger, iris_testing)) %>%
  bind_cols(select(iris_testing, Species)) %>%
  metrics(Species, .pred_setosa:.pred_virginica, estimate = .pred_class)

```


---
# Bibliografía

- Tutorial de Tidymodels
https://rviews.rstudio.com/2019/06/19/a-gentle-intro-to-tidymodels/
- Tutorial de Tidymodels (español)
https://diegokoz.github.io/EEA2019/clase%208/tidymodels.nb.html
- parsnip: A tidy model interface - Max Kuhn (video)
bit.ly/parsnip-rstudioconf2019 
- Recipes for data Preprocessing - Max Kuhn (video)
bit.ly/recipes-useR2018



---

```{r } 
sessionInfo() 
```
